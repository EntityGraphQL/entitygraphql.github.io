"use strict";(self.webpackChunkentity_graphql_docs=self.webpackChunkentity_graphql_docs||[]).push([[892],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},s=Object.keys(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),c=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,s=e.originalType,l=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),u=c(n),h=a,m=u["".concat(l,".").concat(h)]||u[h]||d[h]||s;return n?r.createElement(m,i(i({ref:t},p),{},{components:n})):r.createElement(m,i({ref:t},p))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var s=n.length,i=new Array(s);i[0]=u;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o.mdxType="string"==typeof e?e:a,i[1]=o;for(var c=2;c<s;c++)i[c]=n[c];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}u.displayName="MDXCreateElement"},6460:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>d,frontMatter:()=>s,metadata:()=>o,toc:()=>c});var r=n(7462),a=(n(7294),n(3905));const s={sidebar_position:10},i="Adding Other Data Sources or Services",o={unversionedId:"schema-creation/other-data-sources",id:"schema-creation/other-data-sources",title:"Adding Other Data Sources or Services",description:"EntityGraphQL lets you add fields that resolve data from other sources other than the core context you created your schema with. This is powerful as it let's you create a single API that brings together multiple data sources into an object graph.",source:"@site/docs/schema-creation/other-data-sources.md",sourceDirName:"schema-creation",slug:"/schema-creation/other-data-sources",permalink:"/docs/schema-creation/other-data-sources",draft:!1,editUrl:"https://github.com/EntityGraphQL/EntityGraphQL/tree/master/docs/docs/schema-creation/other-data-sources.md",tags:[],version:"current",sidebarPosition:10,frontMatter:{sidebar_position:10},sidebar:"tutorialSidebar",previous:{title:"Directives",permalink:"/docs/schema-creation/directives"},next:{title:"Subscriptions",permalink:"/docs/schema-creation/subscriptions"}},l={},c=[{value:"<code>ResolveWithService&lt;TService&gt;()</code> Fields",id:"resolvewithservicetservice-fields",level:2},{value:"Services With Non-Scalar Types",id:"services-with-non-scalar-types",level:2},{value:"Connecting Back to the Core Context",id:"connecting-back-to-the-core-context",level:2},{value:"Complex Service Types",id:"complex-service-types",level:2},{value:"Limitation using services with <code>[GraphQLField]</code> method fields",id:"limitation-using-services-with-graphqlfield-method-fields",level:2}],p={toc:c};function d(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"adding-other-data-sources-or-services"},"Adding Other Data Sources or Services"),(0,a.kt)("p",null,"EntityGraphQL lets you add fields that resolve data from other sources other than the core context you created your schema with. This is powerful as it let's you create a single API that brings together multiple data sources into an object graph."),(0,a.kt)("h2",{id:"resolvewithservicetservice-fields"},(0,a.kt)("inlineCode",{parentName:"h2"},"ResolveWithService<TService>()")," Fields"),(0,a.kt)("p",null,"To use other services in a field we use the ",(0,a.kt)("inlineCode",{parentName:"p"},"ResolveWithService<TService>()")," method on the field. EntityGraphQL uses the ",(0,a.kt)("inlineCode",{parentName:"p"},"IServiceProvider")," you pass on execution to resolve the services."),(0,a.kt)("p",null,"Let's use a service in our ",(0,a.kt)("inlineCode",{parentName:"p"},"Person")," type example."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cs"},'schema.UpdateType<Person>(personType => {\n    personType.AddField("age", "Person\'s age")\n        .ResolveWithService<IAgeService>((person, srv) => srv.GetAge(person.Dob));\n});\n\n// Startup.cs\nservices.AddSingleton<IAgeService, AgeService>();\n\n// AgeService.cs\npublic class AgeService\n{\n    public int GetAge(DateTime dob)\n    {\n        return (now - dob).TotalYears;\n    }\n}\n')),(0,a.kt)("p",null,"Now when someone requests the ",(0,a.kt)("inlineCode",{parentName:"p"},"age")," field on a person the result will be resolved by executing the service ",(0,a.kt)("inlineCode",{parentName:"p"},"srv.GetAge(person.Dob)"),". Of course you could calculate the age directly in the field's resolve expression without a service, this is just a demonstration on how to use other services."),(0,a.kt)("h2",{id:"services-with-non-scalar-types"},"Services With Non-Scalar Types"),(0,a.kt)("p",null,"A service can return any type. If it is a complex type you will need to add it to the schema."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cs"},'schema.Query().AddField("users", "Get list of users")\n    .ResolveWithService<IUserService>(\n        // ctx is the core context we created the schema with. For this field we don\'t use it\n        (ctx, srv) => srv.GetUsers(),\n    );\n\nschema.AddType<User>("User", "User information")\n    .AddAllFields();\n\npublic class UserService : IUserService\n{\n    public List<User> GetUsers() { ... }\n}\n\npublic class User\n{\n    public int Id { get; set; }\n    public string Email { get; set; }\n}\n')),(0,a.kt)("h2",{id:"connecting-back-to-the-core-context"},"Connecting Back to the Core Context"),(0,a.kt)("p",null,"With the User example above you might want to add fields to the ",(0,a.kt)("inlineCode",{parentName:"p"},"User")," type that brings in data back from the core context. This let's you create a rich object graph for querying."),(0,a.kt)("p",null,"When joining non-core context types back to the core context you need to use ",(0,a.kt)("inlineCode",{parentName:"p"},"ResolveWithService()")," again."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cs"},'schema.UpdateType<User>(userType => {\n    userType.AddField("tasks", "List of projects assigned to the user")\n        .ResolveWithService<DemoContext>(\n            (user, db) => db.Projects.Where(project => project.AssignedToId == user.Id)\n        );\n});\n')),(0,a.kt)("p",null,"Now we get query the user and their projects at the same time."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-graphql"},"query {\n  users {\n    name\n    projects {\n      name\n      summary\n    }\n  }\n}\n")),(0,a.kt)("h2",{id:"complex-service-types"},"Complex Service Types"),(0,a.kt)("p",null,"If the type you want to define in the schema has data resolved from multiple different methods in your service you can create a service type class."),(0,a.kt)("p",null,"Let's say we want a root-level ",(0,a.kt)("inlineCode",{parentName:"p"},"metrics")," field where each sub-field uses a service to load the value. If someone only queries 1 of the fields you don't want all of them to resolve/execute. To achieve this we can do the following."),(0,a.kt)("p",null,"Define a ",(0,a.kt)("inlineCode",{parentName:"p"},"Metrics")," class that uses a service to provide the functionality."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cs"},"public class Metrics\n{\n    private IMetricService m;\n    public Metrics(IMetricService m)\n    {\n        this.m = m;\n    }\n    public int TotalWebhooks => m.TotalWebhooks();\n    public int TotalApiKeys => m.TotalApiKeys();\n    public int TotalUsers => m.TotalUsers();\n}\n")),(0,a.kt)("p",null,"No we can add the types & fields to GraphQL."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cs"},'// add the type\nvar metricsType = adminSchema.AddType<Metrics>("Metrics", "Contains summary metrics")\n    .AddAllFields();\n\n// add the root-level field\nadminSchema.Query().AddField("metrics", "Return summary metrics")\n    .ResolveWithService<IMetricService>(\n        (db, m) => new Metrics(m)\n    );\n}\n')),(0,a.kt)("p",null,"Now we can query"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-graphql"},"{\n  metrics {\n    totalWebhooks\n  }\n}\n")),(0,a.kt)("p",null,"To demonstrate that only the ",(0,a.kt)("inlineCode",{parentName:"p"},"m.TotalWebhooks()")," method is called here is what is produced as the .NET expression."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cs"},"(MyDbContext db, IMetricService m) => {\n    var context = new Metric(m);\n    return new\n    {\n        totalWebhooks = context.TotalWebhooks,\n    }\n};\n")),(0,a.kt)("p",null,"You'll see none of the other fields are in the expression and therefore the methods will not execute."),(0,a.kt)("h2",{id:"limitation-using-services-with-graphqlfield-method-fields"},"Limitation using services with ",(0,a.kt)("inlineCode",{parentName:"h2"},"[GraphQLField]")," method fields"),(0,a.kt)("p",null,"Because EntityGraphQL handles service fields by executing an expression without those fields and ",(0,a.kt)("em",{parentName:"p"},"rewriting")," the expressions to work with the resulting type - see ",(0,a.kt)("a",{parentName:"p",href:"../library-compatibility/entity-framework"},"How EntityGraphQL handles services")," section for more details - you cannot use services with a method as EntityGraphQL cannot rewrite and data may be missing."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cs"},"public class Movie\n{\n    public int Id { get; set; }\n    // ...\n\n    [GraphQLField]\n    public uint[] AgesOfActorsAtRelease(IAgeCalculator calc)\n    {\n        List<uint> ages = calc.CalculateAges(Released, Actors);\n        return ages\n    }\n}\n\npublic class AgeCalulator : IAgeCalculator\n{\n    public List<uint> CalculateAges(DateTime released, IEnumerable<Actor>)\n    {\n        var ages = new List<uint>();\n        foreach (var actor in actors)\n        {\n            ages.Add((uint)((released - actor.Person.Dob).Days / 365));\n        }\n        return ages.ToArray();\n    }\n}\n")),(0,a.kt)("p",null,"With a query:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-graphql"},"{\n  movies {\n    title\n    released\n    agesOfActorsAtRelease\n  }\n}\n")),(0,a.kt)("p",null,"In the above example ",(0,a.kt)("inlineCode",{parentName:"p"},"AgesOfActorsAtRelease")," is a method on type ",(0,a.kt)("inlineCode",{parentName:"p"},"Movie"),". ",(0,a.kt)("a",{parentName:"p",href:"../library-compatibility/entity-framework"},"When EntityGraphQL executes service fields")," it first builds and executes executes the following (which is safe for EF)."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cs"},"(DemoContext ctx) = > ctx.Movies.Select(m => new {\n    title = m.Title,\n    released = m.Released\n}).ToList();\n")),(0,a.kt)("p",null,"The resulting type is no longer ",(0,a.kt)("inlineCode",{parentName:"p"},"Movie")," and we can no longer find the ",(0,a.kt)("inlineCode",{parentName:"p"},"AgesOfActorsAtRelease")," method. Please use the API on ",(0,a.kt)("inlineCode",{parentName:"p"},"Field")," as above:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cs"},'schema.UpdateType<Movie>(type => {\n    type.AddField("agesOfActorsAtRelease", "All the actors ages")\n        .ResolveWithService<IAgeCalculator>((movie, srv) => srv.CalculateAges(movie.Released, movie.Actors));\n});\n')),(0,a.kt)("p",null,"As ",(0,a.kt)("inlineCode",{parentName:"p"},"(movie, srv) => srv.CalculateAges(movie.Released, movie.Actors)")," is an expression, EntityGraphQL can rewrite it to work with the first execution result. It also can visit the expression tree to know that ",(0,a.kt)("inlineCode",{parentName:"p"},"Released")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"Actors")," needs to be selected in that first execution."),(0,a.kt)("p",null,"If you use ",(0,a.kt)("inlineCode",{parentName:"p"},"ExecutionOptions.ExecuteServiceFieldsSeparately = false")," you will need to make sure all data is available / handle possible ",(0,a.kt)("inlineCode",{parentName:"p"},"null"),"s."))}d.isMDXComponent=!0}}]);